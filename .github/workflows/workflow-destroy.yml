name: MANUAL - Destroy Terraform Infra

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente que será destruído'
        required: true
        type: choice
        options:
          - dev
          - prod
      confirm:
        description: 'Digite "destruir" para confirmar a operação.'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Terraform Validate
    uses: ./.github/workflows/terraform-validate.yml
    with:
      environment: 'dev'
      is_develop_or_main_branch: false
      is_destroy: true
    secrets:
      aws-assume-role-arn: ${{ secrets.DEV_AWS_ASSUME_ROLE_ARN }}

  # Job para destruir o ambiente de desenvolvimento
  destroy-dev:
    if: ${{ github.event.inputs.confirm == 'destruir' && github.event.inputs.environment == 'dev' }}
    needs: validate
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: 'dev'
    secrets:
      aws-assume-role-arn: ${{ secrets.DEV_AWS_ASSUME_ROLE_ARN }}
  
  destroy-prod:
    if: ${{ github.event.inputs.confirm == 'destruir' && github.event.inputs.environment == 'prod' }}
    needs: validate
    uses: ./.github/workflows/terraform-destroy.yml
    with:
      environment: 'prod'
    secrets:
      aws-assume-role-arn: ${{ secrets.PROD_AWS_ASSUME_ROLE_ARN }}
    
  # Job para cancelar a execução se a confirmação estiver errada
  cancel-if-not-confirmed:
    if: ${{ github.event.inputs.confirm != 'destruir' }}
    runs-on: ubuntu-latest
    steps:
      - name: Cancel workflow
        run: |
          echo "::error::Ação cancelada. A confirmação 'destruir' não foi inserida corretamente."
          exit 1